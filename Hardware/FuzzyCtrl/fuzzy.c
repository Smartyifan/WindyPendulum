/**
  ******************************************************************************
  * @file    	E:\GitRepo\WindyPendulum\Hardware\FuzzyCtrl\fuzzy.c
  * @author  	贾一帆
  * @version	V0.0
  * @date  		2015-07-28 11:28:10
  * @brief   	模糊控制器
  ******************************************************************************
  * @attention
  *
  ******************************************************************************
  */  

/* Includes ------------------------------------------------------------------*/
#include "FuzzyCtrl/fuzzy.h"
#include "stm32f10x.h"
#include "stdlib.h"
/** @addtogroup STM32F10x_StdPeriph_Template
  * @{
  */
#include "sys/sys.h"
#include "JY901/jy901.h"
#include "PID/pid.h"
#include "UpperMachine/upmac.h"

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
float Ke = 0.4,Kc = 4.5,Ku = 1;
s8 PlusFuzCtrlArray[13][13] = 
{
 {-60, -60, -60, -60, -60, -60, -60, -50, -40, -30, -20, -10, 0},
 {-60, -60, -60, -55, -50, -50, -50, -40, -30, -20, -10, -5, 0},
 {-60, -60, -60, -50, -40, -40, -40, -30, -20, -10, 0, 0, 0},
 {-60, -55, -50, -45, -40, -35, -30, -20, -10, -5, 0, 5, 10},
 {-60, -50, -40, -40, -40, -30, -20, -10, 0, 0, 0, 10, 20},
 {-50, -40, -30, -30, -30, -20, -10, 0, 10, 10, 10, 20, 30},
 {-40, -30, -20, -20, -20, -10, 0, 10, 20, 20, 20, 30, 40},
 {-30, -20, -10, -10, -10, 0, 10, 20, 30, 30, 30, 40, 50},
 {-20, -10, 0, 0, 0, 10, 20, 30, 40, 40, 40, 50, 60},
 {-10, -5, 0, 5, 10, 20, 30, 35, 40, 45, 50, 55, 60},
 {0, 0, 0, 10, 20, 30, 40, 40, 40, 50, 60, 60, 60},
 {0, 5, 10, 20, 30, 40, 50, 50, 50, 55, 60, 60, 60},
 {0, 10, 20, 30, 40, 50, 60, 60, 60, 60, 60, 60, 60}
};

s8 NegFuzCtrlArray[13][13] = 
{
 {60, 60, 60, 60, 60, 60, 60, 50, 40, 30, 20, 10, 0},
 {60, 60, 60, 55, 50, 50, 50, 40, 30, 20, 10, 5, 0},
 {60, 60, 60, 50, 40, 40, 40, 30, 20, 10, 0, 0, 0},
 {60, 55, 50, 45, 40, 35, 30, 20, 10, 5, 0, -5, -10},
 {60, 50, 40, 40, 40, 30, 20, 10, 0, 0, 0, -10, -20},
 {60, 50, 40, 35, 30, 20, 10, 0, -10, -15, -20, -30, -40},
 {60, 50, 40, 30, 20, 10, 0, -10, -20, -30, -40, -50, -60},
 {40, 30, 20, 15, 10, 0, -10, -20, -30, -35, -40, -50, -60},
 {20, 10, 0, 0, 0, -10, -20, -30, -40, -40, -40, -50, -60},
 {10, 5, 0, -5, -10, -20, -30, -35, -40, -45, -50, -55, -60},
 {0, 0, 0, -10, -20, -30, -40, -40, -40, -50, -60, -60, -60},
 {0, -5, -10, -20, -30, -40, -50, -50, -50, -55, -60,-60, -60},
 {0, -10, -20, -30, -40, -50, -60, -60, -60, -60, -60, -60, -60}
};
/* Private function prototypes -----------------------------------------------*/
/* Private functions ---------------------------------------------------------*/
/**
  *@brief   Initial
  *@param   None;
  *@retval  None
  */
void FuzzyControler(float e,float de){
	s8 plusdeltu =0,negdelu=0;
	s8 eSet = 0,deSet = 0;
	/* 将物理论域转换为模糊论域 ------------------------------------------------*/
	eSet = (s8)(Ke * e+0.5); 	//四舍五入取整
	deSet = (s8)(Kc * de+0.5);
	/* 判断所属模糊集 ---------------------------------------------------------*/
	if(eSet > 6) eSet = 6;				//限制范围为-6~6
	else if(eSet < -6) eSet = -6;
	
	if(deSet > 6) deSet = 6;
	else if(deSet < -6) deSet = -6;
	
	/* 反模糊 ----------------------------------------------------------------*/
	/* 查表得出模糊输出 -----------------------------------*/
	plusdeltu = PlusFuzCtrlArray[eSet+6][deSet+6];
	negdelu = NegFuzCtrlArray[eSet+6][deSet+6];
	/* 乘以增益系数 ---------------------------------------*/
	plusdeltu *= Ku;
	negdelu *= Ku;
	
	/* 将增量加入控制 ---------------------------------------------------------*/
	motor2 += (s16)negdelu;
	motor4 += (s16)plusdeltu;

}

/******************* (C) COPYRIGHT 2014 STMicroelectronics *****END OF FILE****/
